<!DOCTYPE html>
<!--[if IE]>  <![endif]-->
<!--[if lt IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie6"> <![endif]-->
<!--[if IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie7"> <![endif]-->
<!--[if IE 8 ]> <html lang="en" dir="ltr" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]> <html lang="en" dir="ltr" class="no-js ie9"> <![endif]-->
<html lang='en' xmlns:og='http://ogp.me/ns#'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='VMware' name='author'>
<meta content='Copyright VMware 2011. All Rights Reserved.' name='copyright'>
<meta content='juhk3p2B-UhzEjLXtqFwDMVLo5Lmy4ZP-zVe7Gxo2Dw' name='google-site-verification'>
<meta content='en-us' http-equiv='Content-Language'>
<meta content='false' http-equiv='imagetoolbar'>
<meta content='true' name='MSSmartTagsPreventParsing'>
<meta content='all' name='robots'>
<meta content='147862838623179' property='fb:app_id'>
<meta content='website' property='og:type'>
<meta content='https://docs.cloudfoundry.com/frameworks/nodejs/nodeAutoReconfig.html' property='og:url'>
<meta content='https://docs.cloudfoundry.com/images/cf100.png' property='og:image'>
<meta content='Cloud Foundry | Node.js Auto-reconfiguration' property='og:title'>
<meta content='Node.js Auto-reconfiguration Feature and FAQs' property='og:description'>
<meta content='en_US' property='og:locale'>
<title>Cloud Foundry | Node.js Auto-reconfiguration</title>
<link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css'>
<link href='/stylesheets/master.css' media='screen' rel='stylesheet' type='text/css'>
<link href='favicon.ico' rel='shortcut icon'>
<link href='/stylesheets/uv_active4d.css' rel='stylesheet' type='text/css'>
<link href='/stylesheets/documentation.css' media='screen' rel='stylesheet' type='text/css'>
<link href='/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css'>
<script src='/js/jquery-1.6.4.min.js' type='text/javascript'></script>
<script src='/js/documentation.js' type='text/javascript'></script>
<script src='/js/jquery.easing.js' type='text/javascript'></script>
<script src='/js/jquery.social.share.1.2.min.js' type='text/javascript'></script>
<!--[if lt IE 9 ]> <link href="/stylesheets/ie.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<!--[if lt IE 8 ]> <link href="/stylesheets/ie7.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<link href='/stylesheets/master-cf.css' media='screen' rel='stylesheet' type='text/css'>
</head>
<body class='api'>
<div class='wrapper'>
<div class='container' id='header'>
<div class='site-wrap'>
<div class='container'>
<div class='span-6 logo-wrap'>
<a href='http://www.cloudfoundry.com'>
<img alt="Cloud Foundry: The Industry's First Open Platform As A Service" height='70' src='/images/logo_header_cloudfoundry.png' width='373'>
<span class='replaced'>Cloud Foundry: The Industry's First Open Platform As A Service</span>
</img>
</a>
</div>
<div class='span-9 last'>
<div class='right'>
<form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input' name='q' placeholder='search' type='text' value=''>
</form>
<ul class='super-nav'>
<li>
<a href='http://my.cloudfoundry.com/signup'>Get an Account</a>
</li>
<li>
<a href='http://my.cloudfoundry.com/micro'>Download Micro</a>
</li>
<li>
<a href='http://support.cloudfoundry.com' rel='external' target='_blank'>Support</a>
</li>
<li>
<a href='http://status.cloudfoundry.com' target='_blank'>Status</a>
</li>
</ul>
</div>
<div id='nav'>
<ul>
<li class='selected'>
<a href='/getting-started.html'>Get Started</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/getinvolved'>Get Involved</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/partners'>Partners</a>
</li>
<li>
<a href='http://blog.cloudfoundry.com'>Blog</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/about'>About</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='main'>
<div class='content-wrap'>
<div class='header-wrap clearfix'>
<div class='site-wrap'>
<h1>Frameworks</h1>
<p class='sub-head'>Node.js Auto-reconfiguration</p>
</div>
</div>
<div class='site-wrap'>
<div class='container content'>
<div class='span-15 prepend-top'>
<div class='span-4'>
<div class='sub-nav'>
<p>
<strong>
<a href='/getting-started.html'>Getting Started</a>
</strong>
Quick steps to deploy your app.
</p>
<form action='http://www.cloudfoundry.com/search' class='search-form-docs' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input-docs' name='q' placeholder='search docs' type='text' value='more:docs'>
</form>
<br>
<br>
<div class='sidebar-shell' id='js-sidebar'>
<div class='js-accordion-list sidebar-module'>
<ul>
<li class='js-topic'>
<h3>
<a href='#'>Frameworks & Languages</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring.html'>Spring</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/java/spring/spring-insight.html'>Spring Insight</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/grails.html'>Grails</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/scala/scala.html'>Scala</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/scala/lift.html'>Lift</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/play/play.html'>Play</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/play/java-getting-started.html'>Java Getting Started</a>
</li>
<li>
<a href='/frameworks/play/scala-getting-started.html'>Scala Getting Started</a>
</li>
<li>
<a href='/frameworks/play/java-mysql.html'>Java App with MySQL</a>
</li>
<li>
<a href='/frameworks/play/java-postgresql.html'>Java App with PostgreSQL</a>
</li>
<li>
<a href='/frameworks/play/java-mongodb.html'>Java App with MongoDB</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/nodejs/nodejs.html'>Node.js</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/nodejs/nodeAutoReconfig.html'>Configuration</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/ruby/ruby-rails-sinatra.html'>Ruby, Rails, Sinatra</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/ruby/ruby.html'>Overview</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-cf.html'>Things to Know</a>
</li>
<li>
<a href='/frameworks/ruby/installing-ruby.html'>Installing Ruby</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-simple.html'>Creating an App</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-0.html'>Rails 3.0</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-1.html'>Rails 3.1</a>
</li>
<li>
<a href='/frameworks/ruby/sinatra.html'>Sinatra</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Infrastructure</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/infrastructure/overview.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/infrastructure/micro/mcf.html'>MCF</a>
<ul class='js-subguides'>
<li>
<a href='/infrastructure/micro/installing-mcf.html'>Installing MCF</a>
</li>
<li>
<a href='/infrastructure/micro/using-mcf.html'>Using MCF</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Services</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/services.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/services/mongodb/mongodb.html'>MongoDB</a>
<ul class='js-subguides'>
<li>
<a href='/services/mongodb/grails-mongodb.html'>Grails</a>
</li>
<li>
<a href='/services/mongodb/nodejs-mongodb.html'>Node.js</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb.html'>Ruby</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb-gridfs.html'>GridFS</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/mysql/mysql-overview.html'>MySQL</a>
<ul class='js-subguides'>
<li>
<a href='/services/mysql/mysql.html'>Introduction</a>
</li>
<li>
<a href='/services/mysql/grails-mysql.html'>Grails</a>
</li>
<li>
<a href='/services/mysql/ruby-mysql.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/rabbitmq/rabbitmq.html'>RabbitMQ</a>
<ul class='js-subguides'>
<li>
<a href='/services/rabbitmq/faq-rabbitmq.html'>FAQ</a>
</li>
<li>
<a href='/services/rabbitmq/nodejs-rabbitmq.html'>Node.js</a>
</li>
<li>
<a href='/services/rabbitmq/ruby-rabbitmq.html'>Ruby</a>
</li>
<li>
<a href='/services/rabbitmq/spring-rabbitmq.html'>Spring</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/redis/redis.html'>Redis</a>
<ul class='js-subguides'>
<li>
<a href='/services/redis/ruby-redis.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/postgres/postgres.html'>vFabric Postgres</a>
<ul class='js-subguides'>
<li>
<a href='/services/postgres/postgres-ruby.html'>Ruby</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Tools</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/tools/vmc/vmc.html'>VMC</a>
<ul class='js-subguides'>
<li>
<a href='/tools/vmc/installing-vmc.html'>Installing</a>
</li>
<li>
<a href='/tools/vmc/debugging.html'>Debugging</a>
</li>
<li>
<a href='/tools/vmc/vmc-quick-ref.html'>Quick Reference</a>
</li>
<li>
<a href='/tools/vmc/vmc-non-interactive.html'>Non-Interactive Mode</a>
</li>
<li>
<a href='/tools/vmc/caldecott.html'>Caldecott</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/STS/sts-eclipse.html'>STS & Eclipse</a>
<ul class='js-subguides'>
<li>
<a href='/tools/STS/configuring-STS.html'>Configuring</a>
</li>
<li>
<a href='/tools/STS/debugging-CF-Eclipse.html'>Debugging</a>
</li>
<li>
<a href='/tools/STS/deploying-CF-Eclipse.html'>Deploying</a>
</li>
<li>
<a href='/tools/STS/remote-CF-Eclipse.html'>Remote Access</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/gallery/box.html'>Box Integration</a>
</li>
<li class='js-subtopic'>
<a href='/tools/deploying-apps.html'>Deploying Apps</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Samples</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/samples/cool-apps.html'>Cool Apps</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Tutorial</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring-getting-started-with-STS.html'>Spring Tutorial</a>
</li>
<li class='js-subtopic'>
<a href='#'>Ruby on Rails Tutorial</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<strong>
<a href='/faq.html'>FAQ</a>
</strong>
Frequently asked questions.
</p>
<p>
<strong>
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' target='_blank'>Forums</a>
</strong>
Join the conversation.
</p>
<p>
<strong>
<a href='http://webinars.cloudfoundry.com'>Webinars</a>
</strong>
Learn more.
</p>
</div>
</div>
<div class='span-11 last'>
<h2>Node.js Auto-reconfiguration Feature and FAQs</h2>
<p class='tags'>
<strong>Tags:</strong>
<span>
<a href="/tags/nodejs" rel="tag">nodejs</a><a href="/tags/autoreconfig" rel="tag">autoreconfig</a><a href="/tags/redis" rel="tag">redis</a><a href="/tags/mongodb" rel="tag">mongodb</a><a href="/tags/mysql" rel="tag">mysql</a><a href="/tags/postgresql" rel="tag">postgresql</a><a href="/tags/rabbitmq" rel="tag">rabbitmq</a><a href="/tags/services" rel="tag">services</a>
</span>
</p>
<p class='timestamp'>
<strong>Last Updated:</strong>
<span>
2012-08-30
</span>
</p>
<div id='social-share'></div>
<h2 id="auto-reconfiguration-for-nodejs-applications">Auto-reconfiguration for Node.js applications</h2>
<p>Cloud Foundry automatically configures your Node.js application to listen on the right port and connect to the services that are bound to it.</p>

<p>For example, if your app is listening for web requests at localhost:3000 and connected to your local MongoDB mongodb://localhost/myDB, you can push it directly to Cloud Foundry without making any changes to your code.</p>

<p>Let’s take a look at ‘before’ &amp; ‘after’ auto-reconfiguration to see how it works.</p>

<h3 id="port-example-before-auto-reconfiguration">Port Example: BEFORE Auto-reconfiguration</h3>

<p>Notice that earlier the user had to get the port from the <code>process.env.VCAP_APP_PORT</code> environment variable and make changes to the code
in order to run it on Cloud Foundry.</p>

<pre><code class="language-javascript"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_APP_PORT</span> <span class="o">||</span> <span class="s1">'3000'</span><span class="p">;</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'Hello World!'</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span></code></pre>

<h3 id="port-example-after-auto-reconfiguration">Port Example: AFTER Auto-reconfiguration</h3>
<p>Now, with auto-reconfiguration, the user can upload the code that was running on localhost with a hard-coded port (3000 in this case), without making any changes to the code itself. And it will still work on Cloud Foundry!</p>

<pre><code class="language-javascript"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>
<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'Hello World!'</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span></code></pre>

<p>Now, let’s take a look at how powerful auto-configuration is by using a MongoDB example.</p>

<h3 id="mongodb-example-before-auto-reconfiguration">MongoDB Example: BEFORE Auto-reconfiguration</h3>
<p>In the below example, you can see that we had a rather messy <code>generate_mongo_url</code> function that figures out what MongoDB’s url should be when the app runs on Cloud Foundry and also on localhost.</p>

<pre><code class="language-javascript"><span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VMC_APP_PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_APP_HOST</span> <span class="o">||</span> <span class="s1">'localhost'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_SERVICES</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_SERVICES</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">mongo</span> <span class="o">=</span> <span class="nx">env</span><span class="p">[</span><span class="s1">'mongodb-2.0'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'credentials'</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">mongo</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"hostname"</span><span class="o">:</span><span class="s2">"localhost"</span><span class="p">,</span>
    <span class="s2">"port"</span><span class="o">:</span><span class="mi">27017</span><span class="p">,</span>
    <span class="s2">"username"</span><span class="o">:</span><span class="s2">""</span><span class="p">,</span>
    <span class="s2">"password"</span><span class="o">:</span><span class="s2">""</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="o">:</span><span class="s2">""</span><span class="p">,</span>
    <span class="s2">"db"</span><span class="o">:</span><span class="s2">"test"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">generate_mongo_url</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">||</span> <span class="s1">'localhost'</span><span class="p">);</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="mi">27017</span><span class="p">);</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">db</span> <span class="o">||</span> <span class="s1">'test'</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">password</span><span class="p">){</span>
    <span class="k">return</span> <span class="s2">"mongodb://"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">password</span> <span class="o">+</span> <span class="s2">"@"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">db</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="k">return</span> <span class="s2">"mongodb://"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">db</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">mongourl</span> <span class="o">=</span> <span class="nx">generate_mongo_url</span><span class="p">(</span><span class="nx">mongo</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">mongourl</span><span class="p">);</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">params</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'url'</span><span class="p">).</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">===</span> <span class="s1">'/history'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">print_visits</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="nx">record_visit</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">record_visit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="cm">/* Connect to the DB and auth */</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">connect</span><span class="p">(</span><span class="nx">mongourl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">conn</span><span class="p">){</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'ips'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">coll</span><span class="p">){</span>
      <span class="cm">/* Simple object to insert: ip address and date */</span>
      <span class="nx">object_to_insert</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'ip'</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">,</span> <span class="s1">'ts'</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">};</span>

      <span class="cm">/* Insert the object then print in response */</span>
      <span class="cm">/* Note the _id has been created */</span>
      <span class="nx">coll</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span> <span class="nx">object_to_insert</span><span class="p">,</span> <span class="p">{</span><span class="nx">safe</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="o">:</span> <span class="s1">'text/plain'</span><span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">object_to_insert</span><span class="p">));</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">print_visits</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="cm">/* Connect to the DB and auth */</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">connect</span><span class="p">(</span><span class="nx">mongourl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">conn</span><span class="p">){</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'ips'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">coll</span><span class="p">){</span>
      <span class="cm">/*find with limit:10 &amp; sort */</span>
      <span class="nx">coll</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="nx">sort</span><span class="o">:</span><span class="p">[[</span><span class="s1">'_id'</span><span class="p">,</span><span class="s1">'desc'</span><span class="p">]]},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">){</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">items</span><span class="p">){</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="o">:</span> <span class="s1">'text/plain'</span><span class="p">});</span>
          <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">"\n"</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre>

<h3 id="mongodb-example-after-auto-reconfiguration">MongoDB Example: AFTER Auto-reconfiguration</h3>

<p>With Auto-reconfig, users don’t need to add code to figure out what the MongoDB’s url should be. They can simply upload their code that’s running on localhost to Cloud Foundry, and it will just work.</p>

<p>PS: Notice <code>var mongoUrl = 'mongodb://localhost:27017/test';</code> is still pointing to MongoDB on localhost and that the <code>generate_mongo_url</code> function is gone.</p>

<pre><code class="language-javascript"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>

<span class="c1">//With auto-reconfig, we don't have to change localhost's MongoDB url</span>
<span class="kd">var</span> <span class="nx">mongoUrl</span> <span class="o">=</span> <span class="s1">'mongodb://localhost:27017/test'</span><span class="p">;</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">params</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'url'</span><span class="p">).</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">===</span> <span class="s1">'/history'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">print_visits</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="nx">record_visit</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">record_visit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="cm">/* Connect to the DB and auth */</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">connect</span><span class="p">(</span><span class="nx">mongoUrl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">conn</span><span class="p">){</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'ips'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">coll</span><span class="p">){</span>
      <span class="cm">/* Simple object to insert: ip address and date */</span>
      <span class="nx">object_to_insert</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'ip'</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">,</span> <span class="s1">'ts'</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">};</span>

      <span class="cm">/* Insert the object then print in response */</span>
      <span class="cm">/* Note the _id has been created */</span>
      <span class="nx">coll</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span> <span class="nx">object_to_insert</span><span class="p">,</span> <span class="p">{</span><span class="nx">safe</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="o">:</span> <span class="s1">'text/plain'</span><span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">object_to_insert</span><span class="p">));</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">print_visits</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="cm">/* Connect to the DB and auth */</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">connect</span><span class="p">(</span><span class="nx">mongourl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">conn</span><span class="p">){</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'ips'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">coll</span><span class="p">){</span>
      <span class="cm">/*find with limit:10 &amp; sort */</span>
      <span class="nx">coll</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="nx">sort</span><span class="o">:</span><span class="p">[[</span><span class="s1">'_id'</span><span class="p">,</span><span class="s1">'desc'</span><span class="p">]]},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">){</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">items</span><span class="p">){</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="o">:</span> <span class="s1">'text/plain'</span><span class="p">});</span>
          <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">"\n"</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre>

<h3 id="under-the-hood">Under the hood</h3>

<p>When your application is staged during the deployment process, Cloud Foundry will make two modifications:</p>

<ul>
<li>It will provide the <a href="https://npmjs.org/package/cf-autoconfig">cf-autoconfig</a> node module to your application.</li>
  <li>It will preload the cf-autoconfig module while bootstrapping your application.</li>
</ul><p>The cf-autoconfig module exploits the Node.js caching mechanism. This module searches application files for supported node modules and redefines module connection functions so that they are being called with Cloud Foundry connection parameters. For example, let’s see how it redefines the connect function of the MongoDB node module:</p>

<pre><code class="language-javascript"><span class="k">if</span> <span class="p">(</span><span class="s2">"connect"</span> <span class="k">in</span> <span class="nx">moduleData</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">oldConnect</span> <span class="o">=</span> <span class="nx">moduleData</span><span class="p">.</span><span class="nx">connect</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">oldConnectProto</span> <span class="o">=</span> <span class="nx">moduleData</span><span class="p">.</span><span class="nx">connect</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
  <span class="nx">moduleData</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">oldConnect</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">moduleData</span><span class="p">.</span><span class="nx">connect</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">oldConnectProto</span><span class="p">;</span>
<span class="p">}</span></code></pre>

<p>Other functions are redefined the same way. Please take a look at the <a href="https://github.com/cloudfoundry/vcap-node/tree/master/cf-autoconfig">cf-autoconfig module source on Github</a>.  Feel free to provide feedback or even submit a pull request.</p>

<h3 id="supported-modules">Supported modules</h3>

<p>The following is the list of supported modules:</p>

<ul>
<li><a href="https://github.com/postwait/node-amqp">amqp</a></li>
  <li><a href="https://github.com/mongodb/node-mongodb-native">mongodb</a></li>
  <li><a href="https://github.com/learnboost/mongoose">mongoose</a></li>
  <li><a href="https://github.com/felixge/node-mysql">mysql</a></li>
  <li><a href="https://github.com/brianc/node-postgres">pg</a></li>
  <li><a href="https://github.com/mranney/node_redis">redis</a></li>
</ul><p>According to <a href="http://www.npmjs.org">npmjs.org</a>, these modules are the most depended on. This means there are many other modules that use these modules for the database connection layer and auto-reconfiguration will be applied to them as well.</p>

<h3 id="limitations">Limitations</h3>

<p>Auto-reconfiguration of services works only under the following conditions:</p>

<ul>
<li>You are using only one service of the given type. For example, one mysql or one redis service.</li>
  <li>You are using the service node module from the list of supported modules above, or any other that is using one of them for service connection underneath.</li>
  <li>Your application does not use cf-runtime or cf-autoconfig node modules.</li>
  <li>Your application is a typical Node.js application. For a complex application, you may need to consider opting out of auto-reconfiguration and using the cf-runtime node module described in the next blog post in this series.</li>
</ul><h3 id="turning-off-auto-reconfiguration">Turning off Auto-reconfiguration</h3>
<p>Auto-reconfiguration can be turned off by creating a <code>cloudfoundry.json</code> file in the application base folder with the option “cfAutoconfig” set as false.</p>

<pre><code class="language-javascript"><span class="p">{</span> <span class="err">“</span><span class="nx">cfAutoconfig</span><span class="err">”</span> <span class="o">:</span> <span class="kc">false</span> <span class="p">}</span></code></pre>

<p>In addition, as mentioned above, auto-reconfiguration will not work if the application is using the cf-runtime node module.</p>

<h2 id="faqs">FAQs</h2>

<h3 id="what-are-the-limitations-of-nodejs-auto-reconfig">1. What are the limitations of Node.js Auto-reconfig?</h3>
<p>Auto-reconfiguration of services works only under the following conditions:</p>

<ul>
<li>You are using only one service of the given type. For example, one mysql or one redis service.</li>
  <li>You are using the service node module from the list of supported modules above, or any other that is using one of them for service connection underneath.</li>
  <li>Your application does not use cf-runtime or cf-autoconfig node modules.</li>
  <li>Your application is a typical Node.js application. For a complex application, you may need to consider opting out of auto-reconfiguration and using the cf-runtime node module described in the next blog post in this series.</li>
</ul><h3 id="is-auto-reconfig-turned-on-by-default">2. Is Auto-reconfig turned on by default?</h3>
<p>Yes.</p>

<h3 id="how-can-i-turn-off-auto-reconfiguration">3. How can I turn off Auto-reconfiguration?</h3>

<p>Auto-reconfiguration can be turned off by creating a <code>cloudfoundry.json</code> file in the application base folder with the option “cfAutoconfig” set as false.</p>

<pre><code class="language-javascript"><span class="p">{</span> <span class="err">“</span><span class="nx">cfAutoconfig</span><span class="err">”</span> <span class="o">:</span> <span class="kc">false</span> <span class="p">}</span></code></pre>

<p>In addition, as mentioned above, auto-reconfiguration will not work if the application is using the cf-runtime node module.</p>

<h3 id="what-version-of-nodejs-is-required">4. What version of Node.js is required?</h3>

<p>Node.js v0.6.x, v0.8.x and above.</p>

<h3 id="how-will-i-know-when-auto-reconfig-doesnt-work">5. How will I know when auto-reconfig doesn’t work?</h3>

<p>Typically you will see ‘could not connect’ to a given service. That’s the clue.</p>

<h3 id="what-are-the-supported-modules--services">6. What are the supported modules / services?</h3>

<p>The following is the list of supported modules:</p>

<ul>
<li><a href="https://github.com/postwait/node-amqp">amqp</a></li>
  <li><a href="https://github.com/mongodb/node-mongodb-native">mongodb</a></li>
  <li><a href="https://github.com/learnboost/mongoose">mongoose</a></li>
  <li><a href="https://github.com/felixge/node-mysql">mysql</a></li>
  <li><a href="https://github.com/brianc/node-postgres">pg</a></li>
  <li><a href="https://github.com/mranney/node_redis">redis</a></li>
</ul><p>According to <a href="http://www.npmjs.org">npmjs.org</a>, these modules are the most depended on. This means there are many other modules that use these modules for the database connection layer and auto-reconfiguration will be applied to them as well.</p>

<h3 id="for-more">For More:</h3>
<p>Please look at the blog here: <a href="http://wp.me/p2wH9O-BS">Auto-reconfiguration for Node.js applications</a></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='footer'>
<div class='site-wrap'>
<div class='row'>
<div class='span-3 social-icons'>
<a class='twitter replaced' href='http://twitter.com/cloudfoundry' rel='external' target='_blank'>Twitter</a>
<a class='facebook replaced' href='http://facebook.com/cloudfoundry' rel='external' target='_blank'>Facebook</a>
<a class='youtube replaced' href='http://www.youtube.com/cloudfoundry' rel='external' target='_blank'>YouTube</a>
</div>
<div class='prepend-2 span-5'>
<p>
<a href='http://www.cloudfoundry.com/faq'>FAQ</a>
|
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' rel='external'>Forums</a>
|
<a href='http://blog.cloudfoundry.com' rel='external'>Blog</a>
|
<a href='http://www.cloudfoundry.com/jobs'>Jobs</a>
|
<a href='http://www.cloudfoundry.com/legal'>Legal</a>
|
<a href='http://www.cloudfoundry.com/terms'>Terms</a>
|
<a href='http://www.vmware.com/help/privacy.html' rel='external' target='_blank'>Privacy</a>
</p>
</div>
<div class='span-5 last right'>
<p>Copyright &copy; 2012 VMware, Inc. All rights reserved.</p>
</div>
</div>
</div>
</div>
<script>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-22181585-10']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    
    $(document).ready(function() {
      $('#social-share').dcSocialShare({
        buttonSize: 'horizontal',
        buttons: 'facebook,twitter,plusone,linkedin',
        location: 'top',
        align: 'right',
        offsetLocation: 260,
        offsetAlign: 100,
        width: 80,
        center: true,
        centerPx: 600,
        disableFloat: true,
        tabText: '',
        twitterId: 'cloudfoundry'
      });
    });
  //]]>
</script>
</body>
</html>
