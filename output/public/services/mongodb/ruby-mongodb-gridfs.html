<!DOCTYPE html>
<!--[if IE]>  <![endif]-->
<!--[if lt IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie6"> <![endif]-->
<!--[if IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie7"> <![endif]-->
<!--[if IE 8 ]> <html lang="en" dir="ltr" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]> <html lang="en" dir="ltr" class="no-js ie9"> <![endif]-->
<html lang='en' xmlns:og='http://ogp.me/ns#'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='VMware' name='author'>
<meta content='Copyright VMware 2011. All Rights Reserved.' name='copyright'>
<meta content='juhk3p2B-UhzEjLXtqFwDMVLo5Lmy4ZP-zVe7Gxo2Dw' name='google-site-verification'>
<meta content='en-us' http-equiv='Content-Language'>
<meta content='false' http-equiv='imagetoolbar'>
<meta content='true' name='MSSmartTagsPreventParsing'>
<meta content='all' name='robots'>
<meta content='147862838623179' property='fb:app_id'>
<meta content='website' property='og:type'>
<meta content='https://docs.cloudfoundry.com/services/mongodb/ruby-mongodb-gridfs.html' property='og:url'>
<meta content='https://docs.cloudfoundry.com/images/cf100.png' property='og:image'>
<meta content='Cloud Foundry | Using MongoDB and GridFS with Ruby' property='og:title'>
<meta content='Ruby Development with MongoDB and GridFS' property='og:description'>
<meta content='en_US' property='og:locale'>
<title>Cloud Foundry | Using MongoDB and GridFS with Ruby</title>
<link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css'>
<link href='/stylesheets/master.css' media='screen' rel='stylesheet' type='text/css'>
<link href='favicon.ico' rel='shortcut icon'>
<link href='/stylesheets/uv_active4d.css' rel='stylesheet' type='text/css'>
<link href='/stylesheets/documentation.css' media='screen' rel='stylesheet' type='text/css'>
<link href='/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css'>
<script src='/js/jquery-1.6.4.min.js' type='text/javascript'></script>
<script src='/js/documentation.js' type='text/javascript'></script>
<script src='/js/jquery.easing.js' type='text/javascript'></script>
<script src='/js/jquery.social.share.1.2.min.js' type='text/javascript'></script>
<!--[if lt IE 9 ]> <link href="/stylesheets/ie.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<!--[if lt IE 8 ]> <link href="/stylesheets/ie7.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<link href='/stylesheets/master-cf.css' media='screen' rel='stylesheet' type='text/css'>
</head>
<body class='api'>
<div class='wrapper'>
<div class='container' id='header'>
<div class='site-wrap'>
<div class='container'>
<div class='span-6 logo-wrap'>
<a href='http://www.cloudfoundry.com'>
<img alt="Cloud Foundry: The Industry's First Open Platform As A Service" height='70' src='/images/logo_header_cloudfoundry.png' width='373'>
<span class='replaced'>Cloud Foundry: The Industry's First Open Platform As A Service</span>
</img>
</a>
</div>
<div class='span-9 last'>
<div class='right'>
<form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input' name='q' placeholder='search' type='text' value=''>
</form>
<ul class='super-nav'>
<li>
<a href='http://my.cloudfoundry.com/signup'>Get an Account</a>
</li>
<li>
<a href='http://my.cloudfoundry.com/micro'>Download Micro</a>
</li>
<li>
<a href='http://support.cloudfoundry.com' rel='external' target='_blank'>Support</a>
</li>
<li>
<a href='http://status.cloudfoundry.com' target='_blank'>Status</a>
</li>
</ul>
</div>
<div id='nav'>
<ul>
<li class='selected'>
<a href='/getting-started.html'>Get Started</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/getinvolved'>Get Involved</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/partners'>Partners</a>
</li>
<li>
<a href='http://blog.cloudfoundry.com'>Blog</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/about'>About</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='main'>
<div class='content-wrap'>
<div class='header-wrap clearfix'>
<div class='site-wrap'>
<h1>Services</h1>
<p class='sub-head'>Using MongoDB and GridFS with Ruby</p>
</div>
</div>
<div class='site-wrap'>
<div class='container content'>
<div class='span-15 prepend-top'>
<div class='span-4'>
<div class='sub-nav'>
<p>
<strong>
<a href='/getting-started.html'>Getting Started</a>
</strong>
Quick steps to deploy your app.
</p>
<form action='http://www.cloudfoundry.com/search' class='search-form-docs' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input-docs' name='q' placeholder='search docs' type='text' value='more:docs'>
</form>
<br>
<br>
<div class='sidebar-shell' id='js-sidebar'>
<div class='js-accordion-list sidebar-module'>
<ul>
<li class='js-topic'>
<h3>
<a href='#'>Frameworks & Languages</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring.html'>Spring</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/java/spring/spring-insight.html'>Spring Insight</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/grails.html'>Grails</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/scala/scala.html'>Scala</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/scala/lift.html'>Lift</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/play/play.html'>Play</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/play/java-getting-started.html'>Java Getting Started</a>
</li>
<li>
<a href='/frameworks/play/scala-getting-started.html'>Scala Getting Started</a>
</li>
<li>
<a href='/frameworks/play/java-mysql.html'>Java App with MySQL</a>
</li>
<li>
<a href='/frameworks/play/java-postgresql.html'>Java App with PostgreSQL</a>
</li>
<li>
<a href='/frameworks/play/java-mongodb.html'>Java App with MongoDB</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/nodejs/nodejs.html'>Node.js</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/nodejs/nodeAutoReconfig.html'>Configuration</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/ruby/ruby-rails-sinatra.html'>Ruby, Rails, Sinatra</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/ruby/ruby.html'>Overview</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-cf.html'>Things to Know</a>
</li>
<li>
<a href='/frameworks/ruby/installing-ruby.html'>Installing Ruby</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-simple.html'>Creating an App</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-0.html'>Rails 3.0</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-1.html'>Rails 3.1</a>
</li>
<li>
<a href='/frameworks/ruby/sinatra.html'>Sinatra</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Infrastructure</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/infrastructure/overview.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/infrastructure/micro/mcf.html'>MCF</a>
<ul class='js-subguides'>
<li>
<a href='/infrastructure/micro/installing-mcf.html'>Installing MCF</a>
</li>
<li>
<a href='/infrastructure/micro/using-mcf.html'>Using MCF</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Services</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/services.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/services/mongodb/mongodb.html'>MongoDB</a>
<ul class='js-subguides'>
<li>
<a href='/services/mongodb/grails-mongodb.html'>Grails</a>
</li>
<li>
<a href='/services/mongodb/nodejs-mongodb.html'>Node.js</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb.html'>Ruby</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb-gridfs.html'>GridFS</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/mysql/mysql-overview.html'>MySQL</a>
<ul class='js-subguides'>
<li>
<a href='/services/mysql/mysql.html'>Introduction</a>
</li>
<li>
<a href='/services/mysql/grails-mysql.html'>Grails</a>
</li>
<li>
<a href='/services/mysql/ruby-mysql.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/rabbitmq/rabbitmq.html'>RabbitMQ</a>
<ul class='js-subguides'>
<li>
<a href='/services/rabbitmq/faq-rabbitmq.html'>FAQ</a>
</li>
<li>
<a href='/services/rabbitmq/nodejs-rabbitmq.html'>Node.js</a>
</li>
<li>
<a href='/services/rabbitmq/ruby-rabbitmq.html'>Ruby</a>
</li>
<li>
<a href='/services/rabbitmq/spring-rabbitmq.html'>Spring</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/redis/redis.html'>Redis</a>
<ul class='js-subguides'>
<li>
<a href='/services/redis/ruby-redis.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/postgres/postgres.html'>vFabric Postgres</a>
<ul class='js-subguides'>
<li>
<a href='/services/postgres/postgres-ruby.html'>Ruby</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Tools</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/tools/vmc/vmc.html'>VMC</a>
<ul class='js-subguides'>
<li>
<a href='/tools/vmc/installing-vmc.html'>Installing</a>
</li>
<li>
<a href='/tools/vmc/debugging.html'>Debugging</a>
</li>
<li>
<a href='/tools/vmc/vmc-quick-ref.html'>Quick Reference</a>
</li>
<li>
<a href='/tools/vmc/vmc-non-interactive.html'>Non-Interactive Mode</a>
</li>
<li>
<a href='/tools/vmc/caldecott.html'>Caldecott</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/STS/sts-eclipse.html'>STS & Eclipse</a>
<ul class='js-subguides'>
<li>
<a href='/tools/STS/configuring-STS.html'>Configuring</a>
</li>
<li>
<a href='/tools/STS/debugging-CF-Eclipse.html'>Debugging</a>
</li>
<li>
<a href='/tools/STS/deploying-CF-Eclipse.html'>Deploying</a>
</li>
<li>
<a href='/tools/STS/remote-CF-Eclipse.html'>Remote Access</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/gallery/box.html'>Box Integration</a>
</li>
<li class='js-subtopic'>
<a href='/tools/deploying-apps.html'>Deploying Apps</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Samples</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/samples/cool-apps.html'>Cool Apps</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Tutorial</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring-getting-started-with-STS.html'>Spring Tutorial</a>
</li>
<li class='js-subtopic'>
<a href='#'>Ruby on Rails Tutorial</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<strong>
<a href='/faq.html'>FAQ</a>
</strong>
Frequently asked questions.
</p>
<p>
<strong>
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' target='_blank'>Forums</a>
</strong>
Join the conversation.
</p>
<p>
<strong>
<a href='http://webinars.cloudfoundry.com'>Webinars</a>
</strong>
Learn more.
</p>
</div>
</div>
<div class='span-11 last'>
<h2>Ruby Development with MongoDB and GridFS</h2>
<p class='tags'>
<strong>Tags:</strong>
<span>
<a href="/tags/mongodb" rel="tag">mongodb</a><a href="/tags/grid-fs" rel="tag">grid-fs</a><a href="/tags/rails" rel="tag">rails</a><a href="/tags/tutorial" rel="tag">tutorial</a>
</span>
</p>
<p class='timestamp'>
<strong>Last Updated:</strong>
<span>
2012-08-30
</span>
</p>
<div id='social-share'></div>
<p>GridFS is a specification for storing files larger than the MongoDB size limit in MongoDB databases. It works by storing the file in chunks, which are managed through an API that treats the collection of chunks as a single ojbect. This tutorial shows how to use GridFS in a Rails application by adding an avatar to the User model.</p>

<p>Many web applications allow users to upload and retrieve generated images, such as profile pictures, photos, or video thumbnails. If you are using Ruby on Rails there are a couple of great frameworks you can use: PaperClip and CarrierWave.</p>

<p>CarrierWave was selected for this project because it seems the least obtrusive and most flexible. CarrierWave can be used with the file system, Amazon S3, or a database, including Mongo GridFS.</p>

<p>The first task is to add images when users register on the app using their Facebook account. Here are the steps to support uploading and serving images. For more details on the Facebook integration review the <code>user.rb</code> model in the source code.</p>

<h2 id="steps-to-perform-on-your-terminal">Steps to Perform on Your Terminal</h2>

<p>This assumes you already have a Ruby on Rails 3.0 application on Cloud Foundry with a Users model.</p>

<pre class="terminal">
# Log in to Cloud Foundry if you are not logged in
$ vmc login youremail@domain.com

$ vmc create-service mongodb

# See what the newly created mongo service is called
$ vmc services

# Bind the service to your existing application
$ vmc bind-service mongodb-???? appname

</pre>

<h2 id="steps-on-your-code-base">Steps on Your Code Base</h2>

<h3 id="dependencies">Dependencies</h3>

<p>Add the following gems to your Gemfile</p>

<pre><code class="language-ruby"><span class="n">gem</span> <span class="s1">'carrierwave'</span>
<span class="n">gem</span> <span class="s1">'carrierwave-mongoid'</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s2">"carrierwave/mongoid"</span></code></pre>

<p>Generate the uploader</p>

<pre class="terminal">
$ rails generate uploader Avatar
</pre>

<p>Edit the generated file, <code>app/uploaders/avadar_uploader.rb</code>, to use grid_fs</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="nc">AvatarUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>

    <span class="c1"># Choose what kind of storage to use for this uploader:</span>
    <span class="n">storage</span> <span class="ss">:grid_fs</span>

    <span class="c1"># Override the directory where uploaded files will be stored.</span>
    <span class="c1"># This is a sensible default for uploaders that are meant to be mounted:</span>
    <span class="k">def</span> <span class="nf">store_dir</span>
        <span class="s2">"</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>

    <span class="c1"># Provide a default URL as a default if there hasn't been a file uploaded:</span>
    <span class="k">def</span> <span class="nf">default_url</span>
        <span class="s2">"/images/fallback/"</span> <span class="o">+</span> <span class="o">[</span><span class="n">version_name</span><span class="p">,</span> <span class="s2">"default.png"</span><span class="o">].</span><span class="n">compact</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'_'</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span></code></pre>

<p>Update your ActiveRecord model to store the avatar.</p>

<p>Make sure you are loading CarrierWave after loading the ORM, otherwise you need to require the relevant extension manually, for example:</p>

<pre><code class="language-ruby"><span class="nb">require</span> <span class="s1">'carrierwave/orm/activerecord'</span></code></pre>

<p>Add a string column to the model on which you want to mount the uploader.</p>

<pre class="terminal">
$ add_column :users, :avatar, :string
</pre>

<p>Open your model file and add code to mount the uploader:</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="nc">User</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
    <span class="n">mount_uploader</span> <span class="ss">:avatar</span><span class="p">,</span> <span class="no">AvatarUploader</span>

    <span class="c1"># Make sure that the avatar is accessible</span>
    <span class="n">attr_accessible</span> <span class="ss">:emails</span><span class="p">,</span> <span class="ss">:avatar</span><span class="p">,</span> <span class="ss">:remote_avatar_url</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:last_name</span> <span class="c1">#....</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span></code></pre>

<p>Create an initializer for Mongoid to use your MongoDB instance on Cloud Foundry. Name it <code>01_mongoid.rb</code> so it runs before everything else.</p>

<pre><code class="language-ruby"><span class="no">Mongoid</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">conn_info</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'VCAP_SERVICES'</span><span class="o">]</span>
    <span class="n">services</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">'VCAP_SERVICES'</span><span class="o">]</span><span class="p">)</span>
    <span class="n">services</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">service_version</span><span class="p">,</span> <span class="n">bindings</span><span class="o">|</span>
      <span class="n">bindings</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">binding</span><span class="o">|</span>
        <span class="k">if</span> <span class="nb">binding</span><span class="o">[</span><span class="s1">'label'</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/mongo/i</span>
          <span class="n">conn_info</span> <span class="o">=</span> <span class="nb">binding</span><span class="o">[</span><span class="s1">'credentials'</span><span class="o">]</span>
          <span class="k">break</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">raise</span> <span class="s2">"could not find connection info for mongo"</span> <span class="k">unless</span> <span class="n">conn_info</span>
  <span class="k">else</span>
    <span class="n">conn_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'hostname'</span> <span class="o">=&gt;</span> <span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'port'</span> <span class="o">=&gt;</span> <span class="mi">27017</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="n">cnx</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">conn_info</span><span class="o">[</span><span class="s1">'hostname'</span><span class="o">]</span><span class="p">,</span> <span class="n">conn_info</span><span class="o">[</span><span class="s1">'port'</span><span class="o">]</span><span class="p">,</span> <span class="ss">:pool_size</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">)</span>
  <span class="n">db</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">[</span><span class="s1">'db'</span><span class="o">]</span>
  <span class="k">if</span> <span class="n">conn_info</span><span class="o">[</span><span class="s1">'username'</span><span class="o">]</span> <span class="ow">and</span> <span class="n">conn_info</span><span class="o">[</span><span class="s1">'password'</span><span class="o">]</span>
    <span class="n">db</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">conn_info</span><span class="o">[</span><span class="s1">'username'</span><span class="o">]</span><span class="p">,</span> <span class="n">conn_info</span><span class="o">[</span><span class="s1">'password'</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">db</span>
<span class="k">end</span></code></pre>

<p>Update your CarrierWave initializer to use the Cloud Foundry MongoDB service.</p>

<pre><code class="language-ruby"><span class="c1">#initializers/carrierwave.rb</span>
<span class="nb">require</span> <span class="s1">'serve_gridfs_image'</span>

<span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="ss">:grid_fs</span>
  <span class="n">config</span><span class="o">.</span><span class="n">grid_fs_connection</span> <span class="o">=</span> <span class="no">Mongoid</span><span class="o">.</span><span class="n">database</span>

  <span class="c1"># Storage access url</span>
  <span class="n">config</span><span class="o">.</span><span class="n">grid_fs_access_url</span> <span class="o">=</span> <span class="s2">"/grid"</span>
<span class="k">end</span></code></pre>

<p>Handle requests for the images in <code>lib/serve_gridfs_image.rb</code>:</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="nc">ServeGridfsImage</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="o">[</span><span class="s2">"PATH_INFO"</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/^\/grid\/(.+)$/</span>
      <span class="n">process_request</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="vg">$1</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">begin</span>
      <span class="no">Mongo</span><span class="o">::</span><span class="no">GridFileSystem</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Mongoid</span><span class="o">.</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
        <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="n">file</span><span class="o">.</span><span class="n">content_type</span> <span class="p">},</span> <span class="o">[</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="o">]]</span>
      <span class="k">end</span>
    <span class="k">rescue</span>
      <span class="o">[</span><span class="mi">404</span><span class="p">,</span> <span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/plain'</span> <span class="p">},</span> <span class="o">[</span><span class="s1">'File not found.'</span><span class="o">]]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h2 id="deploy">Deploy</h2>

<pre class="terminal">
$ bundle install
    bundle package
    vmc update app_name
</pre>

<h2 id="conclusion">Conclusion</h2>

<p>This will give you the ability to upload and serve images. Do note that it does not provide image resizing. If you are using devise for example you can import the avatar(profile picture) of the user when they sign up.</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">new_with_session</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
      <span class="k">super</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">[</span><span class="s1">'devise.omniauth_info'</span><span class="o">]</span>
          <span class="k">if</span> <span class="n">data</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="s1">'devise.omniauth_info'</span><span class="o">][</span><span class="s1">'user_info'</span><span class="o">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'name'</span><span class="o">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key?</span> <span class="s1">'name'</span>
            <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'email'</span><span class="o">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'nickname'</span><span class="o">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key?</span> <span class="s1">'nickname'</span>
            <span class="n">user</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'first_name'</span><span class="o">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key?</span> <span class="s1">'first_name'</span>
            <span class="n">user</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'last_name'</span><span class="o">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key?</span> <span class="s1">'last_name'</span>
            <span class="n">user</span><span class="o">.</span><span class="n">remote_avatar_url</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'image'</span><span class="o">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key?</span> <span class="s1">'image'</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre>

<h2 id="references">References</h2>

<ul>
<li><a href="http://support.cloudfoundry.com/entries/20016922-connecting-to-a-mongo-db">Connecting to a MongoDB Database</a></li>
  <li><a href="https://github.com/jnicklas/carrierwave">CarrierWave</a></li>
  <li><a href="https://github.com/jnicklas/carrierwave-mongoid">CarrierWave for Mongoid</a></li>
  <li><a href="http://antekpiechnik.com/posts/setting-up-carrierwave-file-uploads-using-gridfs-on-rails-3-and-mongoid">Setting up CarrierWave file uploads using GridFS on Rails 3 and mongoid</a></li>
  <li><a href="https://github.com/plataformatec/devise">Devise</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='footer'>
<div class='site-wrap'>
<div class='row'>
<div class='span-3 social-icons'>
<a class='twitter replaced' href='http://twitter.com/cloudfoundry' rel='external' target='_blank'>Twitter</a>
<a class='facebook replaced' href='http://facebook.com/cloudfoundry' rel='external' target='_blank'>Facebook</a>
<a class='youtube replaced' href='http://www.youtube.com/cloudfoundry' rel='external' target='_blank'>YouTube</a>
</div>
<div class='prepend-2 span-5'>
<p>
<a href='http://www.cloudfoundry.com/faq'>FAQ</a>
|
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' rel='external'>Forums</a>
|
<a href='http://blog.cloudfoundry.com' rel='external'>Blog</a>
|
<a href='http://www.cloudfoundry.com/jobs'>Jobs</a>
|
<a href='http://www.cloudfoundry.com/legal'>Legal</a>
|
<a href='http://www.cloudfoundry.com/terms'>Terms</a>
|
<a href='http://www.vmware.com/help/privacy.html' rel='external' target='_blank'>Privacy</a>
</p>
</div>
<div class='span-5 last right'>
<p>Copyright &copy; 2012 VMware, Inc. All rights reserved.</p>
</div>
</div>
</div>
</div>
<script>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-22181585-10']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    
    $(document).ready(function() {
      $('#social-share').dcSocialShare({
        buttonSize: 'horizontal',
        buttons: 'facebook,twitter,plusone,linkedin',
        location: 'top',
        align: 'right',
        offsetLocation: 260,
        offsetAlign: 100,
        width: 80,
        center: true,
        centerPx: 600,
        disableFloat: true,
        tabText: '',
        twitterId: 'cloudfoundry'
      });
    });
  //]]>
</script>
</body>
</html>
