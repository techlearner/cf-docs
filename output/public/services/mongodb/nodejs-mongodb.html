<!DOCTYPE html>
<!--[if IE]>  <![endif]-->
<!--[if lt IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie6"> <![endif]-->
<!--[if IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie7"> <![endif]-->
<!--[if IE 8 ]> <html lang="en" dir="ltr" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]> <html lang="en" dir="ltr" class="no-js ie9"> <![endif]-->
<html lang='en' xmlns:og='http://ogp.me/ns#'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='VMware' name='author'>
<meta content='Copyright VMware 2011. All Rights Reserved.' name='copyright'>
<meta content='juhk3p2B-UhzEjLXtqFwDMVLo5Lmy4ZP-zVe7Gxo2Dw' name='google-site-verification'>
<meta content='en-us' http-equiv='Content-Language'>
<meta content='false' http-equiv='imagetoolbar'>
<meta content='true' name='MSSmartTagsPreventParsing'>
<meta content='all' name='robots'>
<meta content='147862838623179' property='fb:app_id'>
<meta content='website' property='og:type'>
<meta content='https://docs.cloudfoundry.com/services/mongodb/nodejs-mongodb.html' property='og:url'>
<meta content='https://docs.cloudfoundry.com/images/cf100.png' property='og:image'>
<meta content='Cloud Foundry | Using MongoDB with Node.js' property='og:title'>
<meta content='Node.js Development with the MongoDB Service' property='og:description'>
<meta content='en_US' property='og:locale'>
<title>Cloud Foundry | Using MongoDB with Node.js</title>
<link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css'>
<link href='/stylesheets/master.css' media='screen' rel='stylesheet' type='text/css'>
<link href='favicon.ico' rel='shortcut icon'>
<link href='/stylesheets/uv_active4d.css' rel='stylesheet' type='text/css'>
<link href='/stylesheets/documentation.css' media='screen' rel='stylesheet' type='text/css'>
<link href='/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css'>
<script src='/js/jquery-1.6.4.min.js' type='text/javascript'></script>
<script src='/js/documentation.js' type='text/javascript'></script>
<script src='/js/jquery.easing.js' type='text/javascript'></script>
<script src='/js/jquery.social.share.1.2.min.js' type='text/javascript'></script>
<!--[if lt IE 9 ]> <link href="/stylesheets/ie.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<!--[if lt IE 8 ]> <link href="/stylesheets/ie7.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<link href='/stylesheets/master-cf.css' media='screen' rel='stylesheet' type='text/css'>
</head>
<body class='api'>
<div class='wrapper'>
<div class='container' id='header'>
<div class='site-wrap'>
<div class='container'>
<div class='span-6 logo-wrap'>
<a href='http://www.cloudfoundry.com'>
<img alt="Cloud Foundry: The Industry's First Open Platform As A Service" height='70' src='/images/logo_header_cloudfoundry.png' width='373'>
<span class='replaced'>Cloud Foundry: The Industry's First Open Platform As A Service</span>
</img>
</a>
</div>
<div class='span-9 last'>
<div class='right'>
<form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input' name='q' placeholder='search' type='text' value=''>
</form>
<ul class='super-nav'>
<li>
<a href='http://my.cloudfoundry.com/signup'>Get an Account</a>
</li>
<li>
<a href='http://my.cloudfoundry.com/micro'>Download Micro</a>
</li>
<li>
<a href='http://support.cloudfoundry.com' rel='external' target='_blank'>Support</a>
</li>
<li>
<a href='http://status.cloudfoundry.com' target='_blank'>Status</a>
</li>
</ul>
</div>
<div id='nav'>
<ul>
<li class='selected'>
<a href='/getting-started.html'>Get Started</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/getinvolved'>Get Involved</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/partners'>Partners</a>
</li>
<li>
<a href='http://blog.cloudfoundry.com'>Blog</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/about'>About</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='main'>
<div class='content-wrap'>
<div class='header-wrap clearfix'>
<div class='site-wrap'>
<h1>Services</h1>
<p class='sub-head'>Using MongoDB with Node.js</p>
</div>
</div>
<div class='site-wrap'>
<div class='container content'>
<div class='span-15 prepend-top'>
<div class='span-4'>
<div class='sub-nav'>
<p>
<strong>
<a href='/getting-started.html'>Getting Started</a>
</strong>
Quick steps to deploy your app.
</p>
<form action='http://www.cloudfoundry.com/search' class='search-form-docs' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input-docs' name='q' placeholder='search docs' type='text' value='more:docs'>
</form>
<br>
<br>
<div class='sidebar-shell' id='js-sidebar'>
<div class='js-accordion-list sidebar-module'>
<ul>
<li class='js-topic'>
<h3>
<a href='#'>Frameworks & Languages</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring.html'>Spring</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/java/spring/spring-insight.html'>Spring Insight</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/grails.html'>Grails</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/scala/scala.html'>Scala</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/scala/lift.html'>Lift</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/play/play.html'>Play</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/play/java-getting-started.html'>Java Getting Started</a>
</li>
<li>
<a href='/frameworks/play/scala-getting-started.html'>Scala Getting Started</a>
</li>
<li>
<a href='/frameworks/play/java-mysql.html'>Java App with MySQL</a>
</li>
<li>
<a href='/frameworks/play/java-postgresql.html'>Java App with PostgreSQL</a>
</li>
<li>
<a href='/frameworks/play/java-mongodb.html'>Java App with MongoDB</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/nodejs/nodejs.html'>Node.js</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/nodejs/nodeAutoReconfig.html'>Configuration</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/ruby/ruby-rails-sinatra.html'>Ruby, Rails, Sinatra</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/ruby/ruby.html'>Overview</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-cf.html'>Things to Know</a>
</li>
<li>
<a href='/frameworks/ruby/installing-ruby.html'>Installing Ruby</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-simple.html'>Creating an App</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-0.html'>Rails 3.0</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-1.html'>Rails 3.1</a>
</li>
<li>
<a href='/frameworks/ruby/sinatra.html'>Sinatra</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Infrastructure</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/infrastructure/overview.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/infrastructure/micro/mcf.html'>MCF</a>
<ul class='js-subguides'>
<li>
<a href='/infrastructure/micro/installing-mcf.html'>Installing MCF</a>
</li>
<li>
<a href='/infrastructure/micro/using-mcf.html'>Using MCF</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Services</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/services.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/services/mongodb/mongodb.html'>MongoDB</a>
<ul class='js-subguides'>
<li>
<a href='/services/mongodb/grails-mongodb.html'>Grails</a>
</li>
<li>
<a href='/services/mongodb/nodejs-mongodb.html'>Node.js</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb.html'>Ruby</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb-gridfs.html'>GridFS</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/mysql/mysql-overview.html'>MySQL</a>
<ul class='js-subguides'>
<li>
<a href='/services/mysql/mysql.html'>Introduction</a>
</li>
<li>
<a href='/services/mysql/grails-mysql.html'>Grails</a>
</li>
<li>
<a href='/services/mysql/ruby-mysql.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/rabbitmq/rabbitmq.html'>RabbitMQ</a>
<ul class='js-subguides'>
<li>
<a href='/services/rabbitmq/faq-rabbitmq.html'>FAQ</a>
</li>
<li>
<a href='/services/rabbitmq/nodejs-rabbitmq.html'>Node.js</a>
</li>
<li>
<a href='/services/rabbitmq/ruby-rabbitmq.html'>Ruby</a>
</li>
<li>
<a href='/services/rabbitmq/spring-rabbitmq.html'>Spring</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/redis/redis.html'>Redis</a>
<ul class='js-subguides'>
<li>
<a href='/services/redis/ruby-redis.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/postgres/postgres.html'>vFabric Postgres</a>
<ul class='js-subguides'>
<li>
<a href='/services/postgres/postgres-ruby.html'>Ruby</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Tools</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/tools/vmc/vmc.html'>VMC</a>
<ul class='js-subguides'>
<li>
<a href='/tools/vmc/installing-vmc.html'>Installing</a>
</li>
<li>
<a href='/tools/vmc/debugging.html'>Debugging</a>
</li>
<li>
<a href='/tools/vmc/vmc-quick-ref.html'>Quick Reference</a>
</li>
<li>
<a href='/tools/vmc/vmc-non-interactive.html'>Non-Interactive Mode</a>
</li>
<li>
<a href='/tools/vmc/caldecott.html'>Caldecott</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/STS/sts-eclipse.html'>STS & Eclipse</a>
<ul class='js-subguides'>
<li>
<a href='/tools/STS/configuring-STS.html'>Configuring</a>
</li>
<li>
<a href='/tools/STS/debugging-CF-Eclipse.html'>Debugging</a>
</li>
<li>
<a href='/tools/STS/deploying-CF-Eclipse.html'>Deploying</a>
</li>
<li>
<a href='/tools/STS/remote-CF-Eclipse.html'>Remote Access</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/gallery/box.html'>Box Integration</a>
</li>
<li class='js-subtopic'>
<a href='/tools/deploying-apps.html'>Deploying Apps</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Samples</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/samples/cool-apps.html'>Cool Apps</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Tutorial</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring-getting-started-with-STS.html'>Spring Tutorial</a>
</li>
<li class='js-subtopic'>
<a href='#'>Ruby on Rails Tutorial</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<strong>
<a href='/faq.html'>FAQ</a>
</strong>
Frequently asked questions.
</p>
<p>
<strong>
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' target='_blank'>Forums</a>
</strong>
Join the conversation.
</p>
<p>
<strong>
<a href='http://webinars.cloudfoundry.com'>Webinars</a>
</strong>
Learn more.
</p>
</div>
</div>
<div class='span-11 last'>
<h2>Node.js Development with the MongoDB Service</h2>
<p class='tags'>
<strong>Tags:</strong>
<span>
<a href="/tags/mongodb" rel="tag">mongodb</a><a href="/tags/nodejs" rel="tag">nodejs</a>
</span>
</p>
<p class='timestamp'>
<strong>Last Updated:</strong>
<span>
2012-08-30
</span>
</p>
<div id='social-share'></div>
<p>Before you begin, review these prerequisites:</p>

<ul>
<li>
    <p><a href="http://cloudfoundry.com/signup">Cloud Foundry account</a> and <a href="/tools/vmc/installing-vmc.html">vmc</a></p>
  </li>
  <li>
    <p><a href="http://nodejs.org/">Node.js</a> installed on your development machine</p>
  </li>
  <li>
    <p><a href="http://www.mongodb.org">MongoDB</a>, the open source NoSQL database, installed on your development computer</p>
  </li>
</ul><p>See <a href="/frameworks/nodejs/nodejs.html">Node.js Application Development with Cloud Foundry</a> for a first tutorial on deploying Node.js applications.</p>

<h2 id="using-the-cloud-foundry-mongodb-service">Using the Cloud Foundry MongoDB Service</h2>

<p>MongoDB is a scalable, open source, document-oriented database provided as a service at Cloud Foundry. This section describes how you can create Node.js applications that use this service. The examples are coded so that you can run and test them locally as well as on Cloud Foundry.
Code for these examples can be found at <a href="https://github.com/gatesvp/cloudfoundry_node_mongodb">GitHub</a>.</p>

<h3 id="setup">Setup</h3>

<p>Start <code>mongod</code> in your local environment with the following command:</p>

<pre class="terminal">
$ mongod
</pre>

<p>Confirm that Node.js is correctly installed:</p>

<ul>
<li>Run <code>node</code> to start the interactive javascript console:</li>
</ul><pre class="terminal">
$ node
</pre>

<p>Press <code>Control-C</code> to exit.</p>

<ul>
<li>Check that Node Package Manager (NPM) is installed:</li>
</ul><pre class="terminal">
$ npm -v
1.0.6
</pre>

<p>Target Cloud Foundry and log in with your Cloud Foundry credentials:</p>

<pre class="terminal">
$ vmc target api.cloudfoundry.com
$ vmc login
</pre>

<h3 id="create-a-working-nodejs-application-for-cloud-foundry">Create a Working Node.js Application for Cloud Foundry</h3>

<p>In this step, you create a basic application and make sure that it works locally and on Cloud Foundry.</p>

<dl>
<dt>Note</dt>
  <dd>Throughout this tutorial, we use the name “mongo-node” for the application. When you deploy to Cloud Foundry you must choose a different, unique name.</dd>
</dl><p>Create an application directory and change into it:</p>

<pre class="terminal">
$ mkdir mongo-node
$ cd mongo-node
</pre>

<p>Create a file <code>app.js</code> containing the following code:</p>

<pre><code class="language-javascript"><span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VMC_APP_PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_APP_HOST</span> <span class="o">||</span> <span class="s1">'localhost'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="o">:</span> <span class="s1">'text/plain'</span><span class="p">});</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'Hello World\n'</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">);</span></code></pre>

<p>This creates a Node.js web server using port 3000 on localhost that responds to any HTTP request with the string “Hello World.”</p>

<p>Start the Node.js web server locally:</p>

<pre class="terminal">
$ node app.js
</pre>

<p>In another terminal window send a request:</p>

<pre class="terminal">
$ curl localhost:3000
Hello World
</pre>

<p>Alternatively, browse to http://localhost:3000 to see the response from the web server.</p>

<p>Press <code>Control-C</code> in the first terminal window to stop the web server.</p>

<p>Push the application to Cloud Foundry. Press <code>Enter</code> to accept the defaults, except enter a unique name for the application, and set up a mongodb service, as shown in the following vmc transcript:</p>

<pre class="terminal">
$ vmc push
    Would you like to deploy from the current directory? [Yn]:
    Application Name: mongo-node
    Application Deployed URL [mongo-node.cloudfoundry.com]:
    Detected a Node.js Application, is this correct? [Yn]:
    Memory Reservation (64M, 128M, 256M, 512M, 1G) [64M]:
    Creating Application: OK
    Would you like to bind any services to 'mongo-node'? [yN]: y
    The following system services are available
    1: mongodb
    2: mysql
    3: postgresql
    4: rabbitmq
    5: redis
    Please select one you wish to provision: 1
    Specify the name of the service [mongodb-e840e]:
    Creating Service: OK
    Binding Service [mongodb-e840e]: OK
    Uploading Application:
      Checking for available resources: OK
      Packing application: OK
      Uploading (0K): OK
    Push Status: OK
    Staging Application: OK
    Starting Application: OK
</pre>

<p>Cloud Foundry stages and starts your application.</p>

<p>Test the application.</p>

<pre class="terminal">
$ curl mongo-node.cloudfoundry.com
	Hello World
</pre>

<h3 id="add-mongodb-configuration">Add MongoDB Configuration</h3>

<p>In the previous step, you deployed the application and bound it to a Cloud Foundry mongodb service, although the application does not yet use the service.</p>

<p>In this step, you update the application to set up MongoDB connection information and credentials, whether the application is running locally or on the cloud.</p>

<ul>
<li>Add the following code to the beginning of <code>app.js</code>:</li>
</ul><pre><code class="language-javascript"><span class="k">if</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_SERVICES</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_SERVICES</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">mongo</span> <span class="o">=</span> <span class="nx">env</span><span class="p">[</span><span class="s1">'mongodb-2.0'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'credentials'</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">else</span><span class="p">{</span>
  <span class="kd">var</span> <span class="nx">mongo</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"hostname"</span><span class="o">:</span><span class="s2">"localhost"</span><span class="p">,</span>
    <span class="s2">"port"</span><span class="o">:</span><span class="mi">27017</span><span class="p">,</span>
    <span class="s2">"username"</span><span class="o">:</span><span class="s2">""</span><span class="p">,</span>
    <span class="s2">"password"</span><span class="o">:</span><span class="s2">""</span><span class="p">,</span>
    <span class="s2">"name"</span><span class="o">:</span><span class="s2">""</span><span class="p">,</span>
    <span class="s2">"db"</span><span class="o">:</span><span class="s2">"db"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">generate_mongo_url</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">||</span> <span class="s1">'localhost'</span><span class="p">);</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="mi">27017</span><span class="p">);</span>
  <span class="nx">obj</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">db</span> <span class="o">||</span> <span class="s1">'test'</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">password</span><span class="p">){</span>
    <span class="k">return</span> <span class="s2">"mongodb://"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">password</span> <span class="o">+</span> <span class="s2">"@"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">db</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="k">return</span> <span class="s2">"mongodb://"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">port</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">db</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">mongourl</span> <span class="o">=</span> <span class="nx">generate_mongo_url</span><span class="p">(</span><span class="nx">mongo</span><span class="p">);</span></code></pre>

<p>The <code>if</code> provides two different sets of information, depending on whether the application is running on the cloud or locally. <code>generate_mongo_url</code> creates appropriate connection information for MongoDB, which is then assigned to mongourl.</p>

<ul>
<li>Test the application locally:</li>
</ul><pre class="terminal">
$ node app.js
</pre>

<ul>
<li>In another terminal:</li>
</ul><pre class="terminal">
$ curl localhost:3000
</pre>

<p>The application returns the string “Hello World”.</p>

<ul>
<li>Update the deployed cloud application:</li>
</ul><pre class="terminal">
$ vmc update mongo-node
    Uploading Application:
      Checking for available resources: OK
      Packing application: OK
      Uploading (1K): OK
    Push Status: OK
    Stopping Application: OK
    Staging Application: OK
    Starting Application: OK
</pre>

<ul>
<li>Test the deployed application:</li>
</ul><pre class="terminal">
$ curl mongo-node.cloudfoundry.com
    Hello World
</pre>

<h3 id="add-mongodb-functionality">Add MongoDB Functionality</h3>

<p>Next, install the MongoDB native drivers locally and update the application to use MongoDB.</p>

<ul>
<li>Install MongoDB native drivers locally:</li>
</ul><pre class="terminal">
$ npm install mongodb
</pre>

<p>This creates a new local directory, <code>node_modules</code>, in the application root.</p>

<ul>
<li>In <code>app.js</code>, create a new function, record_visit, that stores the server request to MongoDB:</li>
</ul><pre><code class="language-javascript"><span class="kd">var</span> <span class="nx">record_visit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="cm">/* Connect to the DB and auth */</span>
  <span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">connect</span><span class="p">(</span><span class="nx">mongourl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">conn</span><span class="p">){</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'ips'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">coll</span><span class="p">){</span>
      <span class="cm">/* Simple object to insert: ip address and date */</span>
      <span class="nx">object_to_insert</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'ip'</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">,</span> <span class="s1">'ts'</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">};</span>

      <span class="cm">/* Insert the object then print in response */</span>
      <span class="cm">/* Note the _id has been created */</span>
      <span class="nx">coll</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span> <span class="nx">object_to_insert</span><span class="p">,</span> <span class="p">{</span><span class="nx">safe</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="o">:</span> <span class="s1">'text/plain'</span><span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">object_to_insert</span><span class="p">));</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre>

<p>The <code>.connect</code> method connects to MongoDB using either the local or Cloud Foundry mongourl.
Then the <code>.collection('ips', ...)</code> method adds the request information to the data that will be committed.</p>

<ul>
<li>Update the <code>http.createServer</code> method so that it calls the <code>record_visit</code> function when the server request is made:</li>
</ul><pre><code class="language-javascript">    <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">record_visit</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">);</span></code></pre>

<ul>
<li>Test the application locally:</li>
</ul><pre class="terminal">
$ node app.js
</pre>

<p>and from another terminal:</p>

<pre class="terminal">
$ curl localhost:3000
    {"ip":"127.0.0.1","ts":"2011-12-29T23:22:38.192Z","_id":"4efcf63ecab9a5b41e000001"}
</pre>

<p>Press Control-C in the first terminal to stop the web server.</p>

<ul>
<li>Test the application on Cloud Foundry:</li>
</ul><pre class="terminal">
$ vmc update mongo-node
$ curl appname.cloudfoundry.com
    {"ip":"127.0.0.1","ts":"2011-12-29T23:24:25.199Z","_id":"4efcf6a927996b5f79000001"}
</pre>

<ul>
<li>Create a function <code>print_visits</code> that prints the last ten visits/requests:</li>
</ul><pre><code class="language-javascript"><span class="kd">var</span> <span class="nx">print_visits</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
<span class="cm">/* Connect to the DB and auth */</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">'mongodb'</span><span class="p">).</span><span class="nx">connect</span><span class="p">(</span><span class="nx">mongourl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">conn</span><span class="p">){</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'ips'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">coll</span><span class="p">){</span>
        <span class="nx">coll</span><span class="p">.</span><span class="nx">find</span><span class="p">({},</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="nx">sort</span><span class="o">:</span><span class="p">[[</span><span class="s1">'_id'</span><span class="p">,</span><span class="s1">'desc'</span><span class="p">]]},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">){</span>
            <span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">items</span><span class="p">){</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="o">:</span> <span class="s1">'text/plain'</span><span class="p">});</span>
                <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">"\n"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="p">}</span></code></pre>

<ul>
<li>Update the <code>createServer</code> method to call the new <code>print_visits</code> function:</li>
</ul><pre><code class="language-javascript"><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">params</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'url'</span><span class="p">).</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">===</span> <span class="s1">'/history'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">print_visits</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="nx">record_visit</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">);</span></code></pre>

<p>Web server requests will either add the current visit to MongoDB (the default) or,
if url includes “/history”, output the last ten visits.</p>

<ul>
<li>Test the application locally:</li>
</ul><pre class="terminal">
$ curl localhost:3000
    {"ip":"127.0.0.1","ts":"2011-12-29T23:44:30.254Z","_id":"4efcfb5e2f9d30481f000003"}
$ curl localhost:3000/history
    {"ip":"127.0.0.1","ts":"2011-12-29T23:44:30.254Z","_id":"4efcfb5e2f9d30481f000003"}
    {"ip":"127.0.0.1","ts":"2011-12-29T23:31:39.339Z","_id":"4efcf85b2f9d30481f000002"}
    {"ip":"127.0.0.1","ts":"2011-12-29T23:31:26.678Z","_id":"4efcf84e2f9d30481f000001"}
    {"ip":"127.0.0.1","ts":"2011-12-29T23:22:38.192Z","_id":"4efcf63ecab9a5b41e000001"}
</pre>

<ul>
<li>Stop the application locally and update it on Cloud Foundry.</li>
</ul><pre class="terminal">
$ vmc update mongo-node
    Uploading Application:
      Checking for available resources: OK
      Processing resources: OK
      Packing application: OK
      Uploading (8K): OK
    Push Status: OK
    Stopping Application: OK
    Staging Application: OK
    Starting Application: OK
</pre>

<ul>
<li>Test the cloud version of the application.</li>
</ul><pre class="terminal">
$ curl mongo-node.cloudfoundry.com/history
    {"ip":"127.0.0.1","ts":"2011-12-29T23:49:46.738Z","_id":"4efcfc9acbfffadc0b000001"}
    {"ip":"127.0.0.1","ts":"2011-12-29T23:24:25.199Z","_id":"4efcf6a927996b5f79000001"}
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='footer'>
<div class='site-wrap'>
<div class='row'>
<div class='span-3 social-icons'>
<a class='twitter replaced' href='http://twitter.com/cloudfoundry' rel='external' target='_blank'>Twitter</a>
<a class='facebook replaced' href='http://facebook.com/cloudfoundry' rel='external' target='_blank'>Facebook</a>
<a class='youtube replaced' href='http://www.youtube.com/cloudfoundry' rel='external' target='_blank'>YouTube</a>
</div>
<div class='prepend-2 span-5'>
<p>
<a href='http://www.cloudfoundry.com/faq'>FAQ</a>
|
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' rel='external'>Forums</a>
|
<a href='http://blog.cloudfoundry.com' rel='external'>Blog</a>
|
<a href='http://www.cloudfoundry.com/jobs'>Jobs</a>
|
<a href='http://www.cloudfoundry.com/legal'>Legal</a>
|
<a href='http://www.cloudfoundry.com/terms'>Terms</a>
|
<a href='http://www.vmware.com/help/privacy.html' rel='external' target='_blank'>Privacy</a>
</p>
</div>
<div class='span-5 last right'>
<p>Copyright &copy; 2012 VMware, Inc. All rights reserved.</p>
</div>
</div>
</div>
</div>
<script>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-22181585-10']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    
    $(document).ready(function() {
      $('#social-share').dcSocialShare({
        buttonSize: 'horizontal',
        buttons: 'facebook,twitter,plusone,linkedin',
        location: 'top',
        align: 'right',
        offsetLocation: 260,
        offsetAlign: 100,
        width: 80,
        center: true,
        centerPx: 600,
        disableFloat: true,
        tabText: '',
        twitterId: 'cloudfoundry'
      });
    });
  //]]>
</script>
</body>
</html>
