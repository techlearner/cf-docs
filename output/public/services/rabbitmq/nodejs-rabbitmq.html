<!DOCTYPE html>
<!--[if IE]>  <![endif]-->
<!--[if lt IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie6"> <![endif]-->
<!--[if IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie7"> <![endif]-->
<!--[if IE 8 ]> <html lang="en" dir="ltr" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]> <html lang="en" dir="ltr" class="no-js ie9"> <![endif]-->
<html lang='en' xmlns:og='http://ogp.me/ns#'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='VMware' name='author'>
<meta content='Copyright VMware 2011. All Rights Reserved.' name='copyright'>
<meta content='juhk3p2B-UhzEjLXtqFwDMVLo5Lmy4ZP-zVe7Gxo2Dw' name='google-site-verification'>
<meta content='en-us' http-equiv='Content-Language'>
<meta content='false' http-equiv='imagetoolbar'>
<meta content='true' name='MSSmartTagsPreventParsing'>
<meta content='all' name='robots'>
<meta content='147862838623179' property='fb:app_id'>
<meta content='website' property='og:type'>
<meta content='https://docs.cloudfoundry.com/services/rabbitmq/nodejs-rabbitmq.html' property='og:url'>
<meta content='https://docs.cloudfoundry.com/images/cf100.png' property='og:image'>
<meta content='Cloud Foundry | Using RabbitMQ with Node.js' property='og:title'>
<meta content='Node.js Application Development with RabbitMQ Service' property='og:description'>
<meta content='en_US' property='og:locale'>
<title>Cloud Foundry | Using RabbitMQ with Node.js</title>
<link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css'>
<link href='/stylesheets/master.css' media='screen' rel='stylesheet' type='text/css'>
<link href='favicon.ico' rel='shortcut icon'>
<link href='/stylesheets/uv_active4d.css' rel='stylesheet' type='text/css'>
<link href='/stylesheets/documentation.css' media='screen' rel='stylesheet' type='text/css'>
<link href='/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css'>
<script src='/js/jquery-1.6.4.min.js' type='text/javascript'></script>
<script src='/js/documentation.js' type='text/javascript'></script>
<script src='/js/jquery.easing.js' type='text/javascript'></script>
<script src='/js/jquery.social.share.1.2.min.js' type='text/javascript'></script>
<!--[if lt IE 9 ]> <link href="/stylesheets/ie.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<!--[if lt IE 8 ]> <link href="/stylesheets/ie7.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<link href='/stylesheets/master-cf.css' media='screen' rel='stylesheet' type='text/css'>
</head>
<body class='api'>
<div class='wrapper'>
<div class='container' id='header'>
<div class='site-wrap'>
<div class='container'>
<div class='span-6 logo-wrap'>
<a href='http://www.cloudfoundry.com'>
<img alt="Cloud Foundry: The Industry's First Open Platform As A Service" height='70' src='/images/logo_header_cloudfoundry.png' width='373'>
<span class='replaced'>Cloud Foundry: The Industry's First Open Platform As A Service</span>
</img>
</a>
</div>
<div class='span-9 last'>
<div class='right'>
<form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input' name='q' placeholder='search' type='text' value=''>
</form>
<ul class='super-nav'>
<li>
<a href='http://my.cloudfoundry.com/signup'>Get an Account</a>
</li>
<li>
<a href='http://my.cloudfoundry.com/micro'>Download Micro</a>
</li>
<li>
<a href='http://support.cloudfoundry.com' rel='external' target='_blank'>Support</a>
</li>
<li>
<a href='http://status.cloudfoundry.com' target='_blank'>Status</a>
</li>
</ul>
</div>
<div id='nav'>
<ul>
<li class='selected'>
<a href='/getting-started.html'>Get Started</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/getinvolved'>Get Involved</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/partners'>Partners</a>
</li>
<li>
<a href='http://blog.cloudfoundry.com'>Blog</a>
</li>
<li>
<a href='http://www.cloudfoundry.com/about'>About</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='main'>
<div class='content-wrap'>
<div class='header-wrap clearfix'>
<div class='site-wrap'>
<h1>Services</h1>
<p class='sub-head'>Using RabbitMQ with Node.js</p>
</div>
</div>
<div class='site-wrap'>
<div class='container content'>
<div class='span-15 prepend-top'>
<div class='span-4'>
<div class='sub-nav'>
<p>
<strong>
<a href='/getting-started.html'>Getting Started</a>
</strong>
Quick steps to deploy your app.
</p>
<form action='http://www.cloudfoundry.com/search' class='search-form-docs' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input-docs' name='q' placeholder='search docs' type='text' value='more:docs'>
</form>
<br>
<br>
<div class='sidebar-shell' id='js-sidebar'>
<div class='js-accordion-list sidebar-module'>
<ul>
<li class='js-topic'>
<h3>
<a href='#'>Frameworks & Languages</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring.html'>Spring</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/java/spring/spring-insight.html'>Spring Insight</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/grails.html'>Grails</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/scala/scala.html'>Scala</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/scala/lift.html'>Lift</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/play/play.html'>Play</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/play/java-getting-started.html'>Java Getting Started</a>
</li>
<li>
<a href='/frameworks/play/scala-getting-started.html'>Scala Getting Started</a>
</li>
<li>
<a href='/frameworks/play/java-mysql.html'>Java App with MySQL</a>
</li>
<li>
<a href='/frameworks/play/java-postgresql.html'>Java App with PostgreSQL</a>
</li>
<li>
<a href='/frameworks/play/java-mongodb.html'>Java App with MongoDB</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/nodejs/nodejs.html'>Node.js</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/nodejs/nodeAutoReconfig.html'>Configuration</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/ruby/ruby-rails-sinatra.html'>Ruby, Rails, Sinatra</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/ruby/ruby.html'>Overview</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-cf.html'>Things to Know</a>
</li>
<li>
<a href='/frameworks/ruby/installing-ruby.html'>Installing Ruby</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-simple.html'>Creating an App</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-0.html'>Rails 3.0</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-1.html'>Rails 3.1</a>
</li>
<li>
<a href='/frameworks/ruby/sinatra.html'>Sinatra</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Infrastructure</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/infrastructure/overview.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/infrastructure/micro/mcf.html'>MCF</a>
<ul class='js-subguides'>
<li>
<a href='/infrastructure/micro/installing-mcf.html'>Installing MCF</a>
</li>
<li>
<a href='/infrastructure/micro/using-mcf.html'>Using MCF</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Services</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/services.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/services/mongodb/mongodb.html'>MongoDB</a>
<ul class='js-subguides'>
<li>
<a href='/services/mongodb/grails-mongodb.html'>Grails</a>
</li>
<li>
<a href='/services/mongodb/nodejs-mongodb.html'>Node.js</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb.html'>Ruby</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb-gridfs.html'>GridFS</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/mysql/mysql-overview.html'>MySQL</a>
<ul class='js-subguides'>
<li>
<a href='/services/mysql/mysql.html'>Introduction</a>
</li>
<li>
<a href='/services/mysql/grails-mysql.html'>Grails</a>
</li>
<li>
<a href='/services/mysql/ruby-mysql.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/rabbitmq/rabbitmq.html'>RabbitMQ</a>
<ul class='js-subguides'>
<li>
<a href='/services/rabbitmq/faq-rabbitmq.html'>FAQ</a>
</li>
<li>
<a href='/services/rabbitmq/nodejs-rabbitmq.html'>Node.js</a>
</li>
<li>
<a href='/services/rabbitmq/ruby-rabbitmq.html'>Ruby</a>
</li>
<li>
<a href='/services/rabbitmq/spring-rabbitmq.html'>Spring</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/redis/redis.html'>Redis</a>
<ul class='js-subguides'>
<li>
<a href='/services/redis/ruby-redis.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/postgres/postgres.html'>vFabric Postgres</a>
<ul class='js-subguides'>
<li>
<a href='/services/postgres/postgres-ruby.html'>Ruby</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Tools</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/tools/vmc/vmc.html'>VMC</a>
<ul class='js-subguides'>
<li>
<a href='/tools/vmc/installing-vmc.html'>Installing</a>
</li>
<li>
<a href='/tools/vmc/debugging.html'>Debugging</a>
</li>
<li>
<a href='/tools/vmc/vmc-quick-ref.html'>Quick Reference</a>
</li>
<li>
<a href='/tools/vmc/vmc-non-interactive.html'>Non-Interactive Mode</a>
</li>
<li>
<a href='/tools/vmc/caldecott.html'>Caldecott</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/STS/sts-eclipse.html'>STS & Eclipse</a>
<ul class='js-subguides'>
<li>
<a href='/tools/STS/configuring-STS.html'>Configuring</a>
</li>
<li>
<a href='/tools/STS/debugging-CF-Eclipse.html'>Debugging</a>
</li>
<li>
<a href='/tools/STS/deploying-CF-Eclipse.html'>Deploying</a>
</li>
<li>
<a href='/tools/STS/remote-CF-Eclipse.html'>Remote Access</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/gallery/box.html'>Box Integration</a>
</li>
<li class='js-subtopic'>
<a href='/tools/deploying-apps.html'>Deploying Apps</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Samples</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/samples/cool-apps.html'>Cool Apps</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>Tutorial</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring-getting-started-with-STS.html'>Spring Tutorial</a>
</li>
<li class='js-subtopic'>
<a href='#'>Ruby on Rails Tutorial</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<strong>
<a href='/faq.html'>FAQ</a>
</strong>
Frequently asked questions.
</p>
<p>
<strong>
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' target='_blank'>Forums</a>
</strong>
Join the conversation.
</p>
<p>
<strong>
<a href='http://webinars.cloudfoundry.com'>Webinars</a>
</strong>
Learn more.
</p>
</div>
</div>
<div class='span-11 last'>
<h2>Node.js Application Development with RabbitMQ Service</h2>
<p class='tags'>
<strong>Tags:</strong>
<span>
<a href="/tags/nodejs" rel="tag">nodejs</a><a href="/tags/rabbitmq" rel="tag">rabbitmq</a><a href="/tags/tutorial" rel="tag">tutorial</a>
</span>
</p>
<p class='timestamp'>
<strong>Last Updated:</strong>
<span>
2012-08-30
</span>
</p>
<div id='social-share'></div>
<p>Node.js is an event-driven, scalable, Javascript-based platform for networking applications. Cloud Foundry provides a runtime environment for Node.js applications and the Cloud Foundry deployment tools recognize Node.js applications.</p>

<p>RabbitMQ is a message broker that provides robust messaging services for your applications.</p>

<p>This is a guide for Node.js developers who are using the Cloud Foundry RabbitMQ service. It shows you how to access the Cloud Foundry RabbitMQ services in your applications.</p>

<p>See <a href="/frameworks/nodejs/nodejs.html">Node.js Application Development with Cloud Foundry</a> for a first tutorial on deploying Node.js applications.</p>

<h3 id="setup">Setup</h3>

<p>Confirm Node.js is correctly installed:</p>

<p>Run node to start the interactive JavaScript console. Press <code>Control-C</code> twice to exit.</p>

<pre class="terminal">
$ node
</pre>

<p>Check that Node Package Manager (NPM) is installed. At the command line:</p>

<pre class="terminal">
$ npm -v
1.0.6
</pre>

<p>Target Cloud Foundry and log in with your Cloud Foundry credentials:</p>

<pre class="terminal">
$ vmc target api.cloudfoundry.com
$ vmc login
</pre>

<h3 id="create-application-files">Create Application Files</h3>

<p>Create an application directory and change into it:</p>

<pre class="terminal">
$ mkdir rabbitmq-node
$ cd rabbitmq-node
</pre>

<p>Create the file <code>package.json</code> with the following contents:</p>

<pre><code class="language-javascript"><span class="p">{</span>
    <span class="s2">"name"</span><span class="o">:</span><span class="s2">"node-amqp-demo"</span><span class="p">,</span>
    <span class="s2">"version"</span><span class="o">:</span><span class="s2">"0.0.1"</span><span class="p">,</span>
    <span class="s2">"dependencies"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"amqp"</span><span class="o">:</span><span class="s2">"&gt;= 0.1.0"</span><span class="p">,</span>
        <span class="s2">"sanitizer"</span><span class="o">:</span> <span class="s2">"*"</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>

<p>This <code>package.json</code> specifies two dependent libraries: amqp for message processing and sanitizer to escape HTML messages.</p>

<p>Install the dependencies, using npm (Node Package Manager):</p>

<pre class="terminal">
$ npm install
</pre>

<p>Create <code>app.js</code> with the following code:</p>

<pre><code class="language-javascript"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">amqp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'amqp'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">URL</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'url'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">htmlEscape</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'sanitizer/sanitizer'</span><span class="p">).</span><span class="nx">escape</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">rabbitUrl</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_SERVICES</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">conf</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_SERVICES</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">conf</span><span class="p">[</span><span class="s1">'rabbitmq-2.4'</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">"amqp://localhost"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VCAP_APP_PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kd">function</span> <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">exchange</span> <span class="o">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">exchange</span><span class="p">(</span><span class="s1">'cf-demo'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'type'</span><span class="o">:</span> <span class="s1">'fanout'</span><span class="p">,</span> <span class="nx">durable</span><span class="o">:</span> <span class="kc">false</span><span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">queue</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="p">{</span><span class="nx">durable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">exclusive</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span>
    <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">queue</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">messages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">htmlEscape</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">body</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">messages</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="nx">queue</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">exchange</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">queue</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'queueBindOk'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">httpServer</span><span class="p">(</span><span class="nx">exchange</span><span class="p">);</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">httpServer</span><span class="p">(</span><span class="nx">exchange</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">serv</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">'GET'</span> <span class="o">&amp;&amp;</span> <span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">==</span> <span class="s1">'/env'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">printEnv</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">'GET'</span> <span class="o">&amp;&amp;</span> <span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">==</span> <span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
      <span class="nx">openHtml</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
      <span class="nx">writeForm</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
      <span class="nx">writeMessages</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
      <span class="nx">closeHtml</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">'POST'</span> <span class="o">&amp;&amp;</span> <span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">==</span> <span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">chunks</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span> <span class="nx">chunks</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span> <span class="p">});</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">msg</span> <span class="o">=</span> <span class="nx">unescapeFormData</span><span class="p">(</span><span class="nx">chunks</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nx">exchange</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="p">{</span><span class="nx">body</span><span class="o">:</span> <span class="nx">msg</span><span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">303</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">'Location'</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">"This is not the page you were looking for."</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">serv</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Starting ... AMQP URL: "</span> <span class="o">+</span> <span class="nx">rabbitUrl</span><span class="p">());</span>
<span class="kd">var</span> <span class="nx">conn</span> <span class="o">=</span> <span class="nx">amqp</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="nx">rabbitUrl</span><span class="p">()});</span>
<span class="nx">conn</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'ready'</span><span class="p">,</span> <span class="nx">setup</span><span class="p">);</span>

<span class="c1">// ---- helpers</span>

<span class="kd">function</span> <span class="nx">openHtml</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">"&lt;html&gt;&lt;head&gt;&lt;title&gt;Node.js / RabbitMQ demo&lt;/title&gt;&lt;/head&gt;&lt;body&gt;"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">closeHtml</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">"&lt;/body&gt;&lt;/html&gt;"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">writeMessages</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'&lt;h2&gt;Messages&lt;/h2&gt;'</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'&lt;ol&gt;'</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">messages</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'&lt;li&gt;'</span> <span class="o">+</span> <span class="nx">messages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'&lt;/ol&gt;'</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">writeForm</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'&lt;form method="post"&gt;'</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'&lt;input name="data"/&gt;&lt;input type="submit"/&gt;'</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">'&lt;/form&gt;'</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">printEnv</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
  <span class="nx">openHtml</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">entry</span> <span class="k">in</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">entry</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">entry</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"&lt;br/&gt;"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">closeHtml</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">unescapeFormData</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">unescape</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'+'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">));</span>
<span class="p">}</span></code></pre>

<p>Push the application to Cloud Foundry. For most prompts you can press <code>Enter</code> to accept the default value.
At the Application Name prompt, enter a unique application name. Also, be sure to create and bind a rabbitmq service, as shown in the following transcript.</p>

<pre class="terminal">
$ vmc push
	Would you like to deploy from the current directory? [Yn]:
	Application Name: rabbitmq-node
	Application Deployed URL [rabbitmq-node.cloudfoundry.com]:
	Detected a Node.js Application, is this correct? [Yn]:
	Memory Reservation (64M, 128M, 256M, 512M) [64M]:
	Creating Application: OK
	Would you like to bind any services to 'rabbitmq-node'? [yN]: y
	Would you like to use an existing provisioned service? [yN]: n
	The following system services are available
	1: mongodb
	2: mysql
	3: postgresql
	4: rabbitmq
	5: redis
	Please select one you wish to provision: 4
	Specify the name of the service [rabbitmq-6c981]:
	Creating Service: OK
	Binding Service [rabbitmq-6c981]: OK
	Uploading Application:
	  Checking for available resources: OK
	  Processing resources: OK
	  Packing application: OK
	  Uploading (1K): OK
	Push Status: OK
	Staging Application: OK
	Starting Application: OK

</pre>

<p>Access the application at the specified URL using your browser. Enter messages in the form and see them echoed in the browser.</p>

<p><img src="/images/screenshots/nodejs-rabbitmq/rmq-app.png" alt="RabbitMQ with Node.js application"></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='footer'>
<div class='site-wrap'>
<div class='row'>
<div class='span-3 social-icons'>
<a class='twitter replaced' href='http://twitter.com/cloudfoundry' rel='external' target='_blank'>Twitter</a>
<a class='facebook replaced' href='http://facebook.com/cloudfoundry' rel='external' target='_blank'>Facebook</a>
<a class='youtube replaced' href='http://www.youtube.com/cloudfoundry' rel='external' target='_blank'>YouTube</a>
</div>
<div class='prepend-2 span-5'>
<p>
<a href='http://www.cloudfoundry.com/faq'>FAQ</a>
|
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' rel='external'>Forums</a>
|
<a href='http://blog.cloudfoundry.com' rel='external'>Blog</a>
|
<a href='http://www.cloudfoundry.com/jobs'>Jobs</a>
|
<a href='http://www.cloudfoundry.com/legal'>Legal</a>
|
<a href='http://www.cloudfoundry.com/terms'>Terms</a>
|
<a href='http://www.vmware.com/help/privacy.html' rel='external' target='_blank'>Privacy</a>
</p>
</div>
<div class='span-5 last right'>
<p>Copyright &copy; 2012 VMware, Inc. All rights reserved.</p>
</div>
</div>
</div>
</div>
<script>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-22181585-10']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    
    $(document).ready(function() {
      $('#social-share').dcSocialShare({
        buttonSize: 'horizontal',
        buttons: 'facebook,twitter,plusone,linkedin',
        location: 'top',
        align: 'right',
        offsetLocation: 260,
        offsetAlign: 100,
        width: 80,
        center: true,
        centerPx: 600,
        disableFloat: true,
        tabText: '',
        twitterId: 'cloudfoundry'
      });
    });
  //]]>
</script>
</body>
</html>
